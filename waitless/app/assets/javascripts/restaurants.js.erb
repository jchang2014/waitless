$(document).ready(function() {
  console.log('yoyoyo');
  queryResults();
});

function queryResults() {
  $('#search-form').on('click', '#search-button', function(e){
    e.preventDefault();

    var request = $.ajax({
      url: "/restaurants",
      action: "get",
      dataType: "JSON",
      data: $('#search-form').serialize()
    }); //end getJSON
    request.done(function(json){
      var markers = json.results;
      updateMap(markers);
      console.log(json);
      $('home-wrapper').hide();
      $('.body-wrapper').html(json.html);
      //$('.body-wrapper').append('<%#=j render 'restaurants/index'  %>');
    });//end done
    request.fail(function(error){
      alert("sorry your search yielded no results");
    });//end fail

    // var secondRequest = $.ajax({
    //     debugger
    //     url: "/restaurants/1",
    //     action: "GET",
    // });
    // secondRequest.done(function(response){
    //   console.log("dddddone");
    //   console.log(response);
    //   $('.home-wrapper').hide();
    //   $('.body-wrapper').html();
    // });
    // secondRequest.fail(function(response){
    //   alert("Failed");
    // });

  }); //end search-form
} //end queryResults

//Google maps
function updateMap(markers) {
  var userLoc = new google.maps.LatLng(markers[0].latitude, markers[0].longitude);
  var mapOptions = {
    zoom: 15,
    center: userLoc
  };

  var infoWindow = new google.maps.InfoWindow();
  var mapDiv = document.getElementById('map-canvas');
  var map = new google.maps.Map(mapDiv, mapOptions);

  for(var i = 0; i < markers.length; i++) {
    var spot = markers[i];
    var latLng = new google.maps.LatLng(spot.latitude, spot.longitude);
    var marker = new google.maps.Marker({
      position: latLng,
      map: map
    });
    (function (marker, spot) {
      google.maps.event.addListener(marker, "click", function() {
          infoWindow.setContent(
            spot.name +
            "<br /> " +
            spot.location[0] +
            "<br /> " +
            "Current wait time: ");
          infoWindow.open(map, marker);
      });
    })(marker, spot);
  }// end for loop
};

